<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spoiler App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #form-container, #processing { margin-bottom: 20px; }
        #progress-bar { width: 100%; background-color: #f0f0f0; }
        #progress { width: 0%; height: 30px; background-color: #4CAF50; text-align: center; line-height: 30px; color: white; }
    </style>
</head>
<body>
    <h1>Spoiler App</h1>
    
    <div id="form-container">
        <form id="spoiler-form">
            <label for="video_url">Video URL:</label>
            <input type="text" id="video_url" name="video_url" required><br><br>
            
            <label for="title">Title:</label>
            <input type="text" id="title" name="title" required><br><br>
            
            <label>Genres:</label><br>
            <input type="checkbox" name="genre" value="Action"> Action
            <input type="checkbox" name="genre" value="Comedy"> Comedy
            <input type="checkbox" name="genre" value="Drama"> Drama
            <input type="checkbox" name="genre" value="Sci-Fi"> Sci-Fi
            <input type="checkbox" name="genre" value="Documentary"> Documentary
            <input type="checkbox" name="genre" value="Other" id="other-checkbox"> Other
            <input type="text" id="otherGenre" name="otherGenre" style="display: none;"><br><br>
            
            <label for="duration">Duration:</label>
            <input type="number" id="duration" name="duration" required>
            <select id="durationType" name="durationType">
                <option value="seconds">Seconds</option>
                <option value="percentage">Percentage</option>
            </select>
            
            <input type="submit" value="Generate Spoiler">
        </form>
    </div>

    <div id="processing" style="display: none;">
        <h2>Processing Your Video</h2>
        <p>Please wait while we generate your spoiler...</p>
        <div id="progress-bar">
            <div id="progress"></div>
        </div>
        <p id="progress-text">0%</p>
    </div>

<script>
    $(document).ready(function() {
        var socket = io();

        $('#other-checkbox').change(function() {
            $('#otherGenre').toggle(this.checked);
        });

        $('#spoiler-form').submit(function(e) {
            e.preventDefault();
            $('#form-container').hide();
            $('#processing').show();

            $.ajax({
                url: '/',
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    console.log('Processing started');
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'An error occurred while processing the video.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    alert('Error: ' + errorMessage);
                    $('#form-container').show();
                    $('#processing').hide();
                }
            });
        });

        socket.on('progress_update', function(data) {
            var progress = Math.round(data.progress);
            $('#progress').css('width', progress + '%');
            $('#progress-text').text(progress + '%');
        });

        socket.on('processing_complete', function(data) {
            window.location.href = '/result?stream_url=' + encodeURIComponent(data.stream_url);
        });

        socket.on('processing_error', function() {
            alert('An error occurred while processing the video. Please try again.');
            $('#form-container').show();
            $('#processing').hide();
        });
    });
</script>
</body>
</html>